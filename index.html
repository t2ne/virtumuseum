<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>VirtuMuseum</title>
    <link rel="icon" href="src/assets/images/b.png" type="image/png" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <link rel="stylesheet" href="src/css/style.css" />
  </head>

  <body>
    <!-- Welcome / Onboarding -->
    <div class="welcome" id="welcome">
      <div class="welcome__card">
        <div class="welcome__brand">VirtuMuseum</div>
        <div class="welcome__title">Bem-vindo ao VirtuMuseum</div>
        <div class="welcome__subtitle">
          Escolhe como queres começar. Podes explorar livremente (WASD + rato)
          ou fazer uma visita guiada <b>manual</b> com setas para avançares ao
          teu ritmo.
        </div>

        <div class="welcome__buttons">
          <button id="btnEnterExplore">Explorar livremente</button>
          <button id="btnEnterTour" class="secondary">Visita guiada</button>
          <button id="btnFullscreenWelcome" class="secondary">
            Fullscreen
          </button>
        </div>

        <div class="welcome__opts">
          <label class="ui__row">
            <input type="checkbox" id="chkWelcomeAmbient" />
            <span>Música ambiente</span>
          </label>
        <!--   <label class="ui__row">
            <input type="checkbox" id="chkWelcomeTTS" />
            <span>Narração (TTS)</span>
          </label> -->
          <label class="ui__row ui__row--split">
            <span>Velocidade movimento</span>
            <input
              id="rngMoveSpeed"
              type="range"
              min="1"
              max="6"
              step="0.5"
              value="2"
            />
          </label>
        </div>

        <div class="welcome__hint">
          Dica: <b>M</b> abre menu · <b>H</b> HUD on/off · <b>Q</b>/<b>E</b>
          anterior/seguinte · visita guiada: usa ←/→ (ou Q/E)
        </div>
      </div>
    </div>

    <div class="ui is-hidden" id="uiRoot">
      <div class="ui__bar">
        <button id="btnMenu" class="secondary" title="Menu (M)">Menu</button>
        <button
          id="btnStop"
          class="secondary"
          title="Terminar visita guiada (Esc)"
        >
          Terminar visita
        </button>
        <button id="btnHUD" class="secondary" title="HUD on/off (H)">
          HUD
        </button>
        <button id="btnFullscreen" class="secondary">Fullscreen</button>
      </div>

      <div class="ui__backdrop" id="menuBackdrop" aria-hidden="true"></div>

      <div class="ui__panel" id="menuPanel" aria-hidden="true">
        <div class="ui__panelHeader">
          <div class="ui__title">VirtuMuseum</div>
          <div class="ui__subtitle">Museu Virtual Interativo</div>
        </div>

        <div class="ui__section">
          <div class="ui__buttons">
            <button id="btnBackToWelcome" class="secondary">
              Voltar ao ecrã inicial
            </button>
          </div>
        </div>

        <div class="ui__section">
          <div class="ui__sectionTitle">Som & Narração</div>
          <label class="ui__row">
            <input type="checkbox" id="chkAmbient" />
            <span>Música ambiente (calma)</span>
          </label>
          <label class="ui__row">
            <input type="checkbox" id="chkTTS" />
            <span>Narração por voz (TTS)</span>
          </label>
          <label class="ui__row ui__row--split">
            <span>Volume</span>
            <input id="rngVolume" type="range" min="0" max="100" value="60" />
          </label>
        </div>

        <div class="ui__section">
          <div class="ui__sectionTitle">Experiência</div>
          <label class="ui__row">
            <input type="checkbox" id="chkReducedMotion" />
            <span>Reduzir movimento (transições)</span>
          </label>
          <label class="ui__row ui__row--split">
            <span>Velocidade da visita</span>
            <input id="rngSpeed" type="range" min="50" max="150" value="100" />
          </label>
          <label class="ui__row ui__row--split">
            <span>Zoom</span>
            <input
              id="rngZoom"
              type="range"
              min="30"
              max="90"
              step="1"
              value="80"
            />
          </label>
          <label class="ui__row ui__row--split">
            <span>Velocidade movimento</span>
            <input
              id="rngMoveSpeedMenu"
              type="range"
              min="1"
              max="6"
              step="0.5"
              value="2"
            />
          </label>
        </div>

        <!--    <div class="ui__section"> -->
        <!--  <div class="ui__sectionTitle">Modo 360</div>
          <div class="ui__buttons">
            <button id="btnModeMuseum" class="secondary">Museu 3D</button>
            <button id="btnModePano" class="secondary">Panorama 360</button>
            <button id="btnModeVideo" class="secondary">Vídeo 360</button> -->
        <!--  </div> -->
        <!--   <label class="ui__row ui__row--stack">
            <span>URL panorama (jpg/png)</span>
            <input
              id="txtPanoUrl"
              placeholder="ex: src/assets/images/panorama.jpg"
            />
          </label> -->
        <!--   <label class="ui__row ui__row--stack">
            <span>URL vídeo 360 (mp4)</span>
            <input
              id="txtVideoUrl"
              placeholder="ex: src/assets/video/video360.mp4"
            />
          </label>
          <div class="ui__buttons">
            <button id="btnApply360" class="secondary">Aplicar</button>
          </div>
        </div>
 -->
        <div class="ui__section">
          <div class="ui__sectionTitle">Teleports (paragens)</div>
          <div id="stopsList" class="ui__list"></div>
        </div>

        <div class="ui__section">
          <div class="ui__sectionTitle">Voz (comandos)</div>
          <div class="ui__buttons">
            <button id="btnVoice" class="secondary">Ativar voz</button>
            <button id="btnHelp" class="secondary">Ajuda</button>
          </div>
          <div class="ui__hint" id="voiceStatus">Voz: desligada</div>
        </div>

        <div class="ui__section">
          <div class="ui__sectionTitle">Ferramentas</div>
          <div class="ui__buttons">
            <button id="btnPhoto" class="secondary" title="Foto (C)">
              Foto
            </button>
            <button id="btnFlashlight" class="secondary" title="Lanterna (F)">
              Lanterna
            </button>
            <button
              id="btnReset"
              class="secondary"
              title="Reset posição/rotação"
            >
              Reset
            </button>
            <button
              id="btnCopyPose"
              class="secondary"
              title="Copiar pos/rot atuais"
            >
              Copiar pose
            </button>
          </div>
          <div class="ui__hint">
            Extra: <b>Q</b>/<b>E</b> anterior/seguinte · <b>C</b> foto ·
            <b>F</b> lanterna
          </div>
        </div>

        <div class="ui__section ui__section--foot">
          <div class="ui__hint">
            Atalhos: <b>M</b> menu · <b>Enter</b> iniciar ·
            <b>Space</b> pausa/retoma · <b>N</b> próxima · <b>Esc</b> parar
          </div>
        </div>
      </div>

      <div class="tourNav is-hidden" id="tourNav" aria-hidden="true">
        <button
          id="btnTourPrev"
          class="secondary ui__tourBtn"
          title="Anterior (←)"
        >
          ←
        </button>
        <button
          id="btnTourNext"
          class="secondary ui__tourBtn"
          title="Seguinte (→)"
        >
          →
        </button>
      </div>
    </div>

    <!-- Info card (HTML) -->
    <div
      class="infoCard is-hidden"
      id="infoCard"
      role="dialog"
      aria-live="polite"
    >
      <div class="infoCard__top">
        <div class="infoCard__title" id="infoCardTitle">—</div>
        <div class="infoCard__actions">
          <button
            class="infoCard__action secondary"
            id="btnInfoImgToggle"
            title="Mostrar/ocultar imagem"
          >
            Imagem
          </button>
          <button
            class="infoCard__action secondary"
            id="btnInfoToggle"
            title="Mostrar/ocultar painel"
          >
            Ocultar
          </button>
          <button
            class="infoCard__close secondary"
            id="btnInfoClose"
            title="Fechar"
          >
            Fechar
          </button>
        </div>
      </div>
      <img class="infoCard__img is-hidden" id="infoCardImg" alt="" />
      <div class="infoCard__desc" id="infoCardDesc"></div>
      <div class="infoCard__hint" id="infoCardHint">
        Dica: usa ← / → para navegar na visita.
      </div>
    </div>

    <a-scene
      keyboard-shortcuts="enterVR: false"
      vr-mode-ui="enabled: false"
      renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true"
      background="color: #0b0b0f"
      fog="type: exponential; density: 0.015; color: #0b0b0f"
      shadow="type: pcfsoft"
    >
      <a-assets>
        <!-- Modelo -->
        <!-- museu.glb -->
        <a-asset-item
          id="museuGLB"
          src="src/assets/models/21-5.glb"
        ></a-asset-item>

        <!-- Media 360 (opcional) -->
        <img id="panoImg" src="" />
        <video
          id="video360"
          src=""
          crossorigin="anonymous"
          playsinline
          webkit-playsinline
        ></video>
      </a-assets>

      <!-- Luzes -->
      <a-entity
        light="type: ambient; intensity: 0.85; color: #ffffff"
      ></a-entity>
      <a-entity
        light="type: directional; intensity: 1.0; castShadow: true"
        position="2 6 3"
      ></a-entity>
      <a-entity
        light="type: directional; intensity: 0.55; castShadow: true"
        position="-2 5 -3"
      ></a-entity>

      <!-- Modelo do museu (ajusta scale/rotation/position) -->
      <a-entity
        id="museuModel"
        gltf-model="#museuGLB"
        gltf-material-fix="doubleSided: true; baseColor: #d9d9df; roughness: 1.0; metalness: 0.0"
        position="0 0 0"
        rotation="0 0 0"
        scale="0.01 0.01 0.01"
      ></a-entity>

      <!-- “Chão” invisível para teleport por clique (comfort) -->
      <a-plane
        id="teleportFloor"
        class="teleportable"
        position="0 0 0"
        rotation="-90 0 0"
        width="220"
        height="220"
        material="color: #000000; opacity: 0.0; transparent: true"
      ></a-plane>

      <!-- Modo 360: sky / videosphere (inicialmente escondidos) -->
      <!--    <a-sky id="sky360" visible="false" color="#101018"></a-sky>
      <a-videosphere
        id="videoSphere"
        visible="false"
        src="#video360"
      ></a-videosphere> -->

      <!-- Hotspots (dá IDs para usar como target) -->

      <!-- RIG: move-se no tour e no WASD -->
      <a-entity
        id="rig"
        position="0.00 0.00 4.00"
        wasd-controls="acceleration: 2; enabled: false; fly: false"
        bounds-keeper="minX: -60; maxX: 60; minZ: -80; maxZ: 80; y: 0"
        print-aim
      >
        <a-camera id="cam" position="0 1.6 0" look-controls="enabled: true">
          <a-cursor
            raycaster="objects: .hotspot, .teleportable, .quadroHitbox"
            fuse="false"
          ></a-cursor>

          <!-- Lanterna (toggle no menu/tecla F) -->
          <a-entity
            id="flashlight"
            light="type: spot; angle: 22; penumbra: 0.2; intensity: 0.0; distance: 18; color: #ffffff"
            position="0 0 0"
          ></a-entity>

          <!-- Painel de info colado à câmara -->
          <a-entity id="infoPanel" visible="false" position="0 -0.22 -1.85">
            <a-plane
              width="2.2"
              height="0.9"
              color="#0f0f14"
              material="opacity: 0.88"
            ></a-plane>

            <a-entity
              id="infoText"
              position="0 0.23 0.01"
              text="value: ; width: 2.0; color: #FFFFFF; wrapCount: 32; lineHeight: 52; align: center; anchor: center;"
            ></a-entity>

            <a-entity
              id="hintText"
              position="0 -0.28 0.01"
              text="value: (clica num hotspot para detalhes); width: 2.0; color: #B7B7C7; wrapCount: 32; lineHeight: 52; align: center; anchor: center;"
            ></a-entity>
          </a-entity>

          <a-entity id="narrator"></a-entity>
        </a-camera>
      </a-entity>

      <!-- Controlador da visita -->
      <a-entity
        id="tour"
        tour-guide="rig: #rig; panel: #infoPanel; text: #infoText; narrator: #narrator; stopsUrl: src/data/tourStops.json; speed: 1.0; autoAdvance: false"
      ></a-entity>

      <!-- Quadros + hitboxes (a partir de PLANE_### no GLB) -->
      <script>
        const museuEl = document.querySelector("#museuModel");

        function pad3(n) {
          return String(n).padStart(3, "0");
        }

        // offset fixo (ligeiro) para evitar z-fighting com a parede
        const DEFAULT_OFFSET = -0.03;

        // offsets por quadro (valores negativos = para dentro da parede)
        const quadroOffsets = {
          "001": -0.7,
          "002": -0.25,
          "003": -0.7,
          "004": -0.25,
          "005": -0.25,
          "006": -0.25,
          "007": -0.25,
          "008": -0.7,
          "009": -0.25,
          "010": -0.25,
          "011": -0.7,
          "012": -0.67,
          "013": -0.67,
          "014": -0.67,
          "015": -0.67,
          "016": -0.67,
          "017": -0.67,
          "018": -0.66,
          "019": -0.2,
          "020": -0.66,
          "021": -0.2,
          "022": -0.2,
          "023": -0.2,
          "024": -0.2,
          "025": -0.67,
          "026": -0.2,
          "027": -0.2,
          "028": -0.67,
          "029": -0.67,
          "030": -0.67,
          "031": -0.67,
        };

        museuEl.addEventListener("model-loaded", () => {
          const root = museuEl.getObject3D("mesh");
          if (!root) return;

          for (let i = 1; i <= 31; i++) {
            const code = pad3(i);
            const planeName = `PLANE_${code}`;

            const marker = root.getObjectByName(planeName);
            if (!marker) {
              console.warn(`${planeName} não encontrado no GLB.`);
              continue;
            }

            // --- transform mundial do marker
            const pos = new THREE.Vector3();
            const quat = new THREE.Quaternion();
            const sca = new THREE.Vector3();
            marker.updateWorldMatrix(true, false);
            marker.matrixWorld.decompose(pos, quat, sca);

            // --- tamanho a partir da geometria
            let width = 1.2;
            let height = 0.8;

            if (marker.geometry) {
              marker.geometry.computeBoundingBox();
              const bb = marker.geometry.boundingBox;
              const sizeLocal = new THREE.Vector3();
              bb.getSize(sizeLocal);

              const worldScale = new THREE.Vector3();
              marker.getWorldScale(worldScale);

              width = sizeLocal.x * worldScale.x;
              height = sizeLocal.y * worldScale.y;

              if (width <= 0.0001) width = 1.2;
              if (height <= 0.0001) height = 0.8;
            }

            // esconder marker do GLB
            marker.visible = false;

            // --- normal da parede
            const normal = new THREE.Vector3(0, 0, 1)
              .applyQuaternion(quat)
              .normalize();

            const offset = quadroOffsets[code] ?? DEFAULT_OFFSET;

            // ===============================
            // QUADRO VISÍVEL
            // ===============================
            const quadro = document.createElement("a-plane");
            quadro.setAttribute("id", `quadro_${code}`);
            quadro.setAttribute("width", width);
            quadro.setAttribute("height", height);
            quadro.setAttribute(
              "material",
              `
        src: url(src/assets/images/Teste/${code}.jpg);
        side: double;
        roughness: 1;
        metalness: 0;
        `
            );

            quadro.object3D.position.copy(pos);
            quadro.object3D.quaternion.copy(quat);
            quadro.object3D.position.add(normal.clone().multiplyScalar(offset));

            museuEl.sceneEl.appendChild(quadro);

            // ===============================
            // HITBOX INVISÍVEL
            // ===============================
            const hit = document.createElement("a-plane");
            hit.classList.add("quadroHitbox");
            hit.setAttribute("data-art", code);
            hit.setAttribute("width", width + 0.08);
            hit.setAttribute("height", height + 0.08);
            hit.setAttribute(
              "material",
              "transparent:true; opacity:0; side: double"
            );

            hit.object3D.position.copy(pos);
            hit.object3D.quaternion.copy(quat);
            hit.object3D.position.add(normal.clone().multiplyScalar(offset));

            hit.addEventListener("click", (e) => {
              // evita que o click "passe" para outras coisas
              e.stopPropagation?.();
              e.preventDefault?.();

              // abre a info do quadro
              window.VirtuMuseum?.openPaintingInfoByCode?.(code);
            });

            museuEl.sceneEl.appendChild(hit);
          }
        });
      </script>

      <!-- O teu JS -->
      <script type="module" src="src/js/app.js"></script>
    </a-scene>
  </body>
</html>
